<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Naviguez intelligemment. Collectionnez mieux – Propulsé par CronoBots">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' https://*.crypto.com https://*.parspng.com https://upload.wikimedia.org; script-src 'self' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline'; connect-src 'self' https://crypto.com;">
    <title>CronoBots</title>
    <link rel="icon" type="image/png" href="/assets/favicon.png">
    <link rel="preload" href="CRONOBOTS.webp" as="image">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js" defer></script>
    <style>
        :root {
            --color1: #FF5733;
            --color2: #2C2C2C;
            --text-dark: #fff;
            --text-light: #333;
            --collection-bg: #1a1a1a;
            --shadow: 0 2px 4px rgba(255,255,255,0.1);
            --bg-light: #f4f4f4;
            --transition: all 0.3s ease;
            --loading-bg: #444;
        }

        [data-theme="light"] {
            --color2: var(--bg-light);
            --text-dark: var(--text-light);
            --collection-bg: #fff;
            --shadow: 0 2px 4px rgba(0,0,0,0.1);
            --color1: #e04e2d;
            --loading-bg: #ccc;
        }

        @font-face {
            font-family: 'Geomanist-Bold';
            src: url('Geomanist-Bold.woff2') format('woff2'),
                 url('Geomanist-Bold.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        body {
            font-family: 'Geomanist-Bold', sans-serif;
            background-color: var(--color2);
            color: var(--text-dark);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            transition: var(--transition);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .navbar-search input[aria-busy="true"]::after {
            content: '';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border: 2px solid var(--color1);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .suggestions {
            position: absolute;
            top: calc(100% + 5px);
            left: 0;
            width: 100%;
            max-width: 250px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: var(--shadow);
            z-index: 1001;
            max-height: 200px;
            overflow-y: auto;
            color: #000;
            display: none;
        }

        .suggestion-item {
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
            tabindex: 0;
        }

        .suggestion-item:focus {
            background-color: var(--color1);
            color: #fff;
            outline: 2px solid var(--color1);
        }

        .nft-card img, .nft-card video {
            width: 100%;
            max-width: 200px;
            height: auto;
            border-radius: 10px;
            margin-bottom: 10px;
            object-fit: cover;
            aspect-ratio: 1 / 1;
            display: block;
            loading: lazy;
        }

        .nft-card .tooltip {
            visibility: hidden;
            background-color: var(--collection-bg);
            color: var(--text-dark);
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 10;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 0.9em;
            box-shadow: var(--shadow);
            opacity: 0;
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }

        .nft-container.thumbnail-mode .nft-card:hover .tooltip,
        .nft-container.thumbnail-mode .nft-card:focus .tooltip {
            visibility: visible;
            opacity: 1;
        }

        .error-container {
            text-align: center;
            margin: 20px;
            display: none;
        }

        .error-container button {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            background-color: var(--color1);
            color: var(--text-dark);
            cursor: pointer;
            font-family: 'Geomanist-Bold', sans-serif;
            text-transform: uppercase;
            font-weight: 700;
            transition: var(--transition);
        }

        @keyframes spin {
            to { transform: translateY(-50%) rotate(360deg); }
        }

        @media screen and (max-width: 768px) {
            .navbar-menu.active {
                display: flex;
                position: fixed;
                top: 60px;
                left: 0;
                width: 100%;
                background-color: var(--collection-bg);
                z-index: 1000;
                padding: 20px;
                flex-direction: column;
            }

            .navbar-menu .close-menu {
                display: block;
                align-self: flex-end;
                font-size: 1.5rem;
                background: none;
                border: none;
                color: var(--text-dark);
                cursor: pointer;
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar" role="navigation" aria-label="Navigation principale">
        <div class="navbar-logo">
            <picture>
                <source srcset="CRONOBOTS.webp" type="image/webp">
                <img src="CRONOBOTS.png" alt="Logo CronoBots" loading="lazy">
            </picture>
            <span class="navbar-logo-text">CRONOBOTS</span>
        </div>
        <div class="navbar-search">
            <input type="text" id="usernameInput" placeholder="Rechercher un profil Crypto.com/NFT" aria-label="Rechercher un profil NFT" aria-describedby="usernameHelp" autocomplete="off" />
            <div class="suggestions" id="suggestions" role="listbox"></div>
        </div>
        <div class="navbar-menu" id="navbarMenu">
            <a href="#collections" aria-label="Voir les collections">Collections</a>
            <a href="#" id="profileLink" aria-label="Voir le profil">Profil</a>
            <a href="https://cronobots.github.io/Cronos/" aria-label="Retour à l'accueil">Accueil</a>
            <button class="close-menu" onclick="toggleMenu()" aria-label="Fermer le menu">✕</button>
        </div>
        <button class="navbar-toggle" aria-label="Ouvrir le menu de navigation" onclick="toggleMenu()">☰</button>
    </nav>

    <div class="main-content" role="main">
        <div class="error-container" id="errorContainer" aria-live="polite">
            <p class="error" id="error"></p>
            <button onclick="window.location.href='https://cronobots.github.io/Cronos/'" aria-label="Retour à l'accueil">Retour à l'accueil</button>
        </div>
        <div class="profile-section">
            <div class="profile-header" id="profileHeader" style="display: none;" aria-live="polite">
                <div class="profile-header-content">
                    <div class="profile-picture">
                        <img id="profilePicture" src="" alt="Photo de profil de l'utilisateur" loading="lazy" />
                    </div>
                    <div class="profile-info">
                        <div class="username-container">
                            <h2 id="username" class="username" aria-label="Nom d'utilisateur"></h2>
                            <img id="verifiedBadge" class="verified-badge" src="https://parspng.com/wp-content/uploads/2022/07/tickpng.parspng.com-4-1024x1024.png" style="display: none;" alt="Badge vérifié" loading="lazy" onerror="this.src='/assets/fallback-verified.png'" />
                        </div>
                        <div class="social-container" id="socialContainer" style="display: none;">
                            <p id="croLink" style="display: none;">
                                <a href="#" target="_blank" id="croUrl" title="Visiter le profil CRO" aria-label="Visiter le profil CRO">
                                    <img src="CRO.png" alt="Profil CRO" class="social-icon" loading="lazy" onerror="this.src='/assets/fallback-icon.png'" />
                                </a>
                            </p>
                            <p id="twitterLink" style="display: none;">
                                <a href="#" target="_blank" id="twitterUrl" title="Visiter le profil X" aria-label="Visiter le profil X">
                                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5a/X_icon_2.svg/512px-X_icon_2.svg.png" alt="Profil X" class="social-icon" loading="lazy" onerror="this.src='/assets/fallback-icon.png'" />
                                </a>
                            </p>
                            <p id="instagramLink" style="display: none;">
                                <a href="#" target="_blank" id="instagramUrl" title="Visiter le profil Instagram" aria-label="Visiter le profil Instagram">
                                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a5/Instagram_icon.png/512px-Instagram_icon.png" alt="Profil Instagram" class="social-icon" loading="lazy" onerror="this.src='/assets/fallback-icon.png'" />
                                </a>
                            </p>
                        </div>
                        <p id="displayName" class="display-name"></p>
                    </div>
                </div>
            </div>
            <!-- Reste du contenu inchangé pour la brièveté -->
        </div>
        <div class="nft-container" id="nftContainer"></div>
        <button id="downloadZipButton" onclick="downloadNFTsAsZip()" style="display: none;">Télécharger .ZIP</button>
        <div class="modal" id="progressModal">
            <div class="modal-content">
                <h3 id="modalTitle">Création du fichier ZIP</h3>
                <div class="progress-bar">
                    <div class="progress" id="progressBar"></div>
                </div>
                <p class="progress-text" id="progressText">Préparation...</p>
                <div class="modal-buttons">
                    <button id="cancelDownloadButton" class="cancel-button">Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <picture>
            <source srcset="CRONOBOTS.webp" type="image/webp">
            <img src="CRONOBOTS.png" alt="Logo CronoBots" class="footer-logo" loading="lazy">
        </picture>
        <p>CRONOBOTS | CRONOS DEVELOPMENT</p>
        <div class="theme-toggle">
            <label for="themeButton">Thème :</label>
            <button id="themeButton">Sombre</button>
        </div>
    </footer>

    <script type="module">
        import DOMPurify from 'https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js';

        const cache = new Map();
        let allNFTs = [];
        let currentUsername = '';
        let isProfileLoadingCancelled = false;
        let isDownloadCancelled = false;
        const graphqlEndpoint = "https://crypto.com/nft-api/graphql";
        const homeUrl = "https://cronobots.github.io/Cronos";

        // Requête GraphQL optimisée
        const profileQuery = `
            query User($id: ID!) {
                public {
                    user(id: $id) {
                        username
                        displayName
                        verified
                        avatar { url }
                        twitterUsername
                        instagramUsername
                    }
                }
            }
        `;

        const nftQuery = `
            query GetProfileAssets($ownerId: ID!, $first: Int!, $skip: Int!) {
                public {
                    profileAssets(ownerId: $ownerId, first: $first, skip: $skip) {
                        id
                        name
                        cover { url }
                        collection { name }
                        createdAt
                        defaultRarityRank
                    }
                }
            }
        `;

        // Sanitisation renforcée avec DOMPurify
        const sanitizeInput = (input) => {
            return DOMPurify.sanitize(input, { ALLOWED_TAGS: [], ALLOWED_ATTR: [] });
        };

        // Validation des URL externes
        const isValidUrl = (url, allowedDomains = ['crypto.com', 'x.com', 'instagram.com']) => {
            try {
                const parsedUrl = new URL(url);
                return allowedDomains.some(domain => parsedUrl.hostname.includes(domain));
            } catch {
                return false;
            }
        };

        // Gestion du menu mobile
        const toggleMenu = () => {
            const menu = document.getElementById('navbarMenu');
            if (menu) {
                menu.classList.toggle('active');
                if (menu.classList.contains('active')) {
                    menu.querySelector('a')?.focus();
                }
            }
        };

        // Afficher les erreurs
        const displayError = (message) => {
            const errorContainer = document.getElementById('errorContainer');
            const errorDiv = document.getElementById('error');
            if (errorContainer && errorDiv) {
                errorDiv.textContent = message;
                errorContainer.style.display = 'block';
            }
        };

        // Recherche de profils avec spinner
        const searchProfiles = async (query) => {
            const suggestions = document.getElementById('suggestions');
            const usernameInput = document.getElementById('usernameInput');
            if (!suggestions || !usernameInput) {
                displayError('Erreur : Éléments de l’interface manquants.');
                return;
            }

            if (!query || query.length < 3) {
                suggestions.innerHTML = '';
                suggestions.style.display = 'none';
                usernameInput.removeAttribute('aria-busy');
                return;
            }

            usernameInput.setAttribute('aria-busy', 'true');
            suggestions.innerHTML = '<div class="suggestion-item">Recherche...</div>';
            suggestions.style.display = 'block';

            try {
                const profileData = await fetchWithCache(`profile_${query.toLowerCase()}`, async () => {
                    const response = await fetch(graphqlEndpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            query: profileQuery,
                            variables: { id: query.toLowerCase() }
                        })
                    });

                    if (!response.ok) throw new Error(`Erreur HTTP : ${response.status}`);
                    const result = await response.json();
                    if (result.errors) throw new Error(result.errors.map(e => e.message).join(', '));
                    return result.data?.public?.user;
                });

                suggestions.innerHTML = '';
                if (profileData?.username) {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.tabIndex = 0;
                    item.innerHTML = `
                        ${profileData.avatar?.url ? `<img src="${sanitizeInput(profileData.avatar.url)}" alt="Avatar de ${sanitizeInput(profileData.username)}" loading="lazy">` : ''}
                        <span>${sanitizeInput(profileData.username)}</span>
                    `;
                    item.addEventListener('click', () => selectSuggestion(profileData.username));
                    item.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') selectSuggestion(profileData.username);
                    });
                    suggestions.appendChild(item);
                    suggestions.style.display = 'block';
                } else {
                    suggestions.innerHTML = '<div class="suggestion-item">Aucun profil trouvé</div>';
                    suggestions.style.display = 'block';
                }
            } catch (error) {
                displayError(`Erreur lors de la recherche : ${error.message}`);
                suggestions.innerHTML = '<div class="suggestion-item">Aucun profil trouvé</div>';
                suggestions.style.display = 'block';
            } finally {
                usernameInput.removeAttribute('aria-busy');
            }
        };

        // Récupérer les NFTs avec pagination
        const fetchAllNFTs = async (ownerId, progressCallback) => {
            const first = 60;
            let skip = 0;
            let allAssets = [];
            let hasMore = true;

            while (hasMore && !isProfileLoadingCancelled) {
                const response = await fetch(graphqlEndpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: nftQuery, variables: { ownerId, first, skip } })
                });

                if (!response.ok) throw new Error(`Erreur HTTP : ${response.status}`);
                const result = await response.json();
                if (result.errors) throw new Error(result.errors.map(e => e.message).join(', '));

                const assets = result.data?.public?.profileAssets || [];
                allAssets = [...allAssets, ...assets];
                skip += first;
                hasMore = assets.length === first;
                if (progressCallback) progressCallback(allAssets.length);
            }

            return isProfileLoadingCancelled ? [] : allAssets;
        };

        // Téléchargement des NFTs en ZIP
        const downloadNFTsAsZip = async () => {
            const zip = new JSZip();
            const filteredNFTs = document.getElementById('collectionFilter')?.value
                ? allNFTs.filter(nft => nft.collection?.name === document.getElementById('collectionFilter').value)
                : [...allNFTs];

            if (filteredNFTs.length === 0) {
                displayError('Aucun NFT disponible pour le téléchargement.');
                return;
            }

            const progressModal = document.getElementById('progressModal');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            if (!progressModal || !progressBar || !progressText) {
                displayError('Erreur : Éléments de l’interface manquants.');
                return;
            }

            progressModal.style.display = 'flex';
            progressText.textContent = `Préparation du téléchargement de ${filteredNFTs.length} NFTs...`;
            progressBar.style.width = '0%';

            document.getElementById('cancelDownloadButton').onclick = () => {
                isDownloadCancelled = true;
                progressText.textContent = 'Téléchargement annulé.';
                progressBar.style.width = '0%';
                setTimeout(() => progressModal.style.display = 'none', 1000);
            };

            const nameCounts = {};
            for (let i = 0; i < filteredNFTs.length; i++) {
                if (isDownloadCancelled) return;
                const asset = filteredNFTs[i];
                const url = asset.cover?.url;
                if (!url) continue;

                const extension = url.endsWith('.mp4') ? '.mp4' : url.endsWith('.gif') ? '.gif' : '.png';
                let baseFileName = sanitizeInput(asset.name || `nft_${i + 1}`);
                baseFileName = baseFileName.replace(/[<>:"/\\|?*]/g, '') || 'unnamed_nft';
                let fileName = nameCounts[baseFileName] ? `${baseFileName}_${nameCounts[baseFileName]}${extension}` : `${baseFileName}${extension}`;
                nameCounts[baseFileName] = (nameCounts[baseFileName] || 0) + 1;

                progressText.textContent = `Téléchargement de ${fileName} (${i + 1}/${filteredNFTs.length})...`;
                progressBar.style.width = `${((i + 1) / filteredNFTs.length) * 100}%`;

                try {
                    const response = await fetch(url, { mode: 'cors', credentials: 'omit' });
                    if (!response.ok) throw new Error(`Échec du téléchargement : ${url}`);
                    const blob = await response.blob();
                    zip.file(fileName, blob);
                } catch (error) {
                    console.error(`Erreur lors du téléchargement de ${url} : ${error.message}`);
                }
            }

            if (!isDownloadCancelled) {
                progressText.textContent = 'Génération du fichier ZIP...';
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                saveAs(zipBlob, `${sanitizeInput(currentUsername)}_nfts.zip`);
                progressModal.style.display = 'none';
            }
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            const themeButton = document.getElementById('themeButton');
            if (themeButton) themeButton.textContent = savedTheme === 'dark' ? 'Sombre' : 'Clair';

            const hash = window.location.hash;
            if (hash && hash.startsWith('#')) {
                const username = sanitizeInput(hash.substring(1).split('/#')[0]);
                if (username) {
                    document.getElementById('usernameInput').value = username;
                    fetchProfileAndNFTs();
                }
            }

            const usernameInput = document.getElementById('usernameInput');
            if (usernameInput) {
                let debounceTimeout;
                usernameInput.addEventListener('input', () => {
                    clearTimeout(debounceTimeout);
                    debounceTimeout = setTimeout(() => searchProfiles(sanitizeInput(usernameInput.value.trim())), 500);
                });
                usernameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        clearTimeout(debounceTimeout);
                        searchProfiles(sanitizeInput(usernameInput.value.trim()));
                    }
                });
            }
        });
    </script>
</body>
</html>
