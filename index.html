<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Naviguez intelligemment. Collectionnez mieux – Propulsé par CronoBots">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' https://*.crypto.com https://*.parspng.com https://upload.wikimedia.org; script-src 'self' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline'; connect-src 'self' https://crypto.com;">
    <title>CronoBots</title>
    <link rel="icon" type="image/png" href="/assets/favicon.png">
    <link rel="preload" href="CRONOBOTS.webp" as="image">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js" defer></script>
    <style>
        :root {
            --color1: #FF5733;
            --color2: #2C2C2C;
            --text-dark: #fff;
            --text-light: #222; /* Amélioration du contraste en mode clair */
            --collection-bg: #1a1a1a;
            --shadow: 0 2px 4px rgba(255,255,255,0.1);
            --bg-light: #f4f4f4;
            --transition: all 0.3s ease;
            --loading-bg: #444;
        }

        [data-theme="light"] {
            --color2: var(--bg-light);
            --text-dark: var(--text-light);
            --collection-bg: #fff;
            --shadow: 0 2px 4px rgba(0,0,0,0.1);
            --color1: #e04e2d;
            --loading-bg: #ccc;
        }

        @font-face {
            font-family: 'Geomanist-Bold';
            src: url('Geomanist-Bold.woff2') format('woff2'),
                 url('Geomanist-Bold.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        body {
            font-family: 'Geomanist-Bold', sans-serif;
            background-color: var(--color2);
            color: var(--text-dark);
            padding: 0;
            margin: 0;
            line-height: 1.6;
            transition: var(--transition);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .navbar {
            background-color: var(--collection-bg);
            padding: 10px 20px;
            display: flex;
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
            flex-wrap: nowrap;
        }

        .navbar-logo img {
            height: 40px;
            loading: lazy;
        }

        .navbar-search {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: 20px;
            position: relative;
            width: 100%;
            max-width: 250px;
        }

        .navbar-search input {
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #444;
            font-size: 14px;
            width: 100%;
            max-width: 250px;
            font-family: 'Geomanist-Bold', sans-serif;
            box-sizing: border-box;
            background-color: #fff;
            color: #000;
        }

        .navbar-search input[aria-busy="true"]::after {
            content: '';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border: 2px solid var(--color1);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .suggestions {
            position: absolute;
            top: calc(100% + 5px);
            left: 0;
            width: 100%;
            max-width: 250px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: var(--shadow);
            z-index: 1001;
            max-height: 200px;
            overflow-y: auto;
            color: #000;
            display: none;
        }

        .suggestion-item {
            padding: 8px 12px;
            color: #000;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            tabindex: 0;
        }

        .suggestion-item:hover, .suggestion-item:focus {
            background-color: var(--color1);
            color: #fff;
            outline: none;
        }

        .nft-card img, .nft-card video {
            width: 100%;
            max-width: 200px;
            height: auto;
            border-radius: 10px;
            margin-bottom: 10px;
            object-fit: cover;
            aspect-ratio: 1 / 1;
            display: block;
            loading: lazy;
        }

        .nft-container.thumbnail-mode .nft-card:hover .tooltip,
        .nft-container.thumbnail-mode .nft-card:focus .tooltip {
            visibility: visible;
            opacity: 1;
        }

        .error-container {
            text-align: center;
            margin-top: 20px;
            display: none;
        }

        .error {
            color: #ff4444;
        }

        @keyframes spin {
            to { transform: translateY(-50%) rotate(360deg); }
        }

        @media screen and (max-width: 768px) {
            .navbar-menu.active {
                display: flex;
                position: absolute;
                top: 100%;
                left: 0;
                width: 100%;
                background-color: var(--collection-bg);
                flex-direction: column;
                padding: 10px;
            }

            .navbar-menu .close-menu {
                display: block;
                align-self: flex-end;
                font-size: 1.5rem;
                background: none;
                border: none;
                color: var(--text-dark);
                cursor: pointer;
                padding: 10px;
            }

            .navbar-toggle {
                display: flex !important;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar" role="navigation" aria-label="Navigation principale">
        <div class="navbar-logo">
            <picture>
                <source srcset="CRONOBOTS.webp" type="image/webp">
                <img src="CRONOBOTS.png" alt="Logo CronoBots" loading="lazy">
            </picture>
            <span class="navbar-logo-text">CRONOBOTS</span>
        </div>
        <div class="navbar-search">
            <input type="text" id="usernameInput" placeholder="Profil Crypto.com/NFT" aria-label="Rechercher un profil NFT" aria-describedby="usernameHelp" autocomplete="off" />
            <div class="suggestions" id="suggestions" role="listbox"></div>
        </div>
        <div class="navbar-menu" id="navbarMenu">
            <a href="#collections" aria-label="Collections">Collections</a>
            <a href="#" id="profileLink" aria-label="Profil">Profil</a>
            <a href="https://cronobots.github.io/Cronos/" aria-label="Accueil">Accueil</a>
            <button class="close-menu" onclick="toggleMenu()" aria-label="Fermer le menu">✕</button>
        </div>
        <button class="navbar-toggle" aria-label="Ouvrir le menu" onclick="toggleMenu()">☰</button>
    </nav>

    <div class="main-content" role="main">
        <div class="error-container" id="errorContainer" aria-live="polite">
            <p class="error" id="error"></p>
            <button onclick="window.location.href='https://cronobots.github.io/Cronos/'" aria-label="Retour à l'accueil">Retour à l'accueil</button>
        </div>
        <div class="profile-section">
            <div class="profile-header" id="profileHeader" style="display: none;" aria-live="polite">
                <div class="profile-header-content">
                    <div class="profile-picture">
                        <img id="profilePicture" src="" alt="Photo de profil" loading="lazy" />
                    </div>
                    <div class="profile-info">
                        <div class="username-container">
                            <h2 id="username" class="username"></h2>
                            <img id="verifiedBadge" class="verified-badge" src="https://parspng.com/wp-content/uploads/2022/07/tickpng.parspng.com-4-1024x1024.png" style="display: none;" alt="Badge vérifié" loading="lazy" onerror="this.src='/assets/fallback-verified.png'" />
                        </div>
                        <div class="social-container" style="display: none;" id="socialContainer">
                            <p id="croLink" style="display: none;">
                                <a href="#" target="_blank" id="croUrl" title="Visiter le profil CRO" aria-label="Visiter le profil CRO">
                                    <img src="CRO.png" alt="Profil CRO" class="social-icon" loading="lazy" onerror="this.src='/assets/fallback-icon.png'" />
                                </a>
                            </p>
                            <p id="twitterLink" style="display: none;">
                                <a href="#" target="_blank" id="twitterUrl" title="Visiter le profil X" aria-label="Visiter le profil X">
                                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5a/X_icon_2.svg/512px-X_icon_2.svg.png" alt="Profil X" class="social-icon" loading="lazy" onerror="this.src='/assets/fallback-icon.png'" />
                                </a>
                            </p>
                            <p id="facebookLink" style="display: none;">
                                <a href="#" target="_blank" id="facebookUrl" title="Visiter le profil Facebook" aria-label="Visiter le profil Facebook">
                                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/51/Facebook_f_logo_%282019%29.svg/512px-Facebook_f_logo_%282019%29.svg.png" alt="Profil Facebook" class="social-icon" loading="lazy" onerror="this.src='/assets/fallback-icon.png'" />
                                </a>
                            </p>
                            <p id="instagramLink" style="display: none;">
                                <a href="#" target="_blank" id="instagramUrl" title="Visiter le profil Instagram" aria-label="Visiter le profil Instagram">
                                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a5/Instagram_icon.png/512px-Instagram_icon.png" alt="Profil Instagram" class="social-icon" loading="lazy" onerror="this.src='/assets/fallback-icon.png'" />
                                </a>
                            </p>
                        </div>
                        <p id="displayName" class="display-name"></p>
                    </div>
                </div>
            </div>
            <div class="controls" id="controls">
                <div class="control-group">
                    <label for="collectionFilter">COLLECTION :</label>
                    <select id="collectionFilter" onchange="filterNFTs()" disabled>
                        <option value="">Toutes les collections</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="displayMode">MODE D'AFFICHAGE :</label>
                    <select id="displayMode" onchange="updateDisplay()">
                        <option value="full">Normal</option>
                        <option value="thumbnail">Vignette</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="cardSize">TAILLE DES CARTES :</label>
                    <select id="cardSize" onchange="updateDisplay()">
                        <option value="small">Petite</option>
                        <option value="medium" selected>Moyenne</option>
                        <option value="large">Grande</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="sortBy">TRIER PAR :</label>
                    <select id="sortBy" onchange="filterNFTs()">
                        <option value="default">Par défaut</option>
                        <option value="rank">Rang</option>
                        <option value="newest">Plus récent</option>
                        <option value="oldest">Plus ancien</option>
                    </select>
                </div>
            </div>
            <h2 id="collectionTitle" class="collection-title"></h2>
        </div>

        <div class="timestamp" id="timestamp"></div>
        <div class="no-results" id="noResults" style="display: none;">Aucun résultat trouvé</div>
        <div id="nftCountContainer"></div>
        <div class="nft-container" id="nftContainer"></div>
        <button id="downloadZipButton" onclick="downloadNFTsAsZip()" style="display: none;">Télécharger .ZIP</button>

        <div class="modal" id="progressModal">
            <div class="modal-content">
                <h3 id="modalTitle">Création du fichier ZIP</h3>
                <div class="progress-bar">
                    <div class="progress" id="progressBar"></div>
                </div>
                <p class="progress-text" id="progressText">Préparation...</p>
                <div class="modal-buttons">
                    <button id="cancelDownloadButton" class="cancel-button">Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <picture>
            <source srcset="CRONOBOTS.webp" type="image/webp">
            <img src="CRONOBOTS.png" alt="Logo CronoBots" class="footer-logo" loading="lazy">
        </picture>
        <p>CRONOBOTS | CRONOS DEVELOPMENT</p>
        <div class="theme-toggle">
            <label for="themeButton">Thème :</label>
            <button id="themeButton">Sombre</button>
        </div>
    </footer>

    <script>
        // Cache pour les requêtes API
        const cache = new Map();
        let allNFTs = [];
        let currentUsername = '';
        let currentDisplayName = '';
        let lastSearchedUsername = '';
        let debounceTimeout = null;
        let isDownloadCancelled = false;
        let isProfileLoadingCancelled = false;

        const graphqlEndpoint = "https://crypto.com/nft-api/graphql";
        const homeUrl = "https://cronobots.github.io/Cronos";

        // Requêtes GraphQL optimisées
        const profileQuery = `
            query User($id: ID!) {
                public {
                    user(id: $id) {
                        username
                        displayName
                        verified
                        avatar { url }
                        twitterUsername
                        instagramUsername
                    }
                }
            }
        `;

        const nftQuery = `
            query GetProfileAssets($ownerId: ID!, $first: Int!, $skip: Int!) {
                public {
                    profileAssets(ownerId: $ownerId, first: $first, skip: $skip) {
                        id
                        name
                        cover { url }
                        collection { name }
                        createdAt
                        defaultRarityRank
                    }
                }
            }
        `;

        // Gestion du menu mobile
        function toggleMenu() {
            const menu = document.getElementById('navbarMenu');
            if (menu) {
                menu.classList.toggle('active');
                if (menu.classList.contains('active')) {
                    menu.querySelector('a')?.focus();
                }
            }
        }

        // Sanitisation des entrées avec DOMPurify
        function sanitizeInput(input) {
            return DOMPurify.sanitize(input, { ALLOWED_TAGS: [], ALLOWED_ATTR: [] });
        }

        // Sanitisation des noms de fichiers pour ZIP
        function sanitizeFileNameForZip(name) {
            return name.replace(/[<>:"/\\|?*]/g, '').trim() || 'unnamed_nft';
        }

        // Validation des URL externes
        function isValidUrl(url, allowedDomains = ['crypto.com', 'x.com', 'instagram.com']) {
            try {
                const parsedUrl = new URL(url);
                return allowedDomains.some(domain => parsedUrl.hostname.includes(domain));
            } catch {
                return false;
            }
        }

        // Gestion du thème
        function toggleTheme() {
            const themeButton = document.getElementById('themeButton');
            if (!themeButton) return;
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            themeButton.textContent = newTheme === 'dark' ? 'Sombre' : 'Clair';
        }

        // Mise en cache des requêtes
        async function fetchWithCache(key, fetchFn) {
            if (cache.has(key)) return cache.get(key);
            try {
                const data = await fetchFn();
                cache.set(key, data);
                return data;
            } catch (error) {
                throw error;
            }
        }

        // Recherche de profils
        async function searchProfiles(query) {
            const suggestions = document.getElementById('suggestions');
            const usernameInput = document.getElementById('usernameInput');
            if (!suggestions || !usernameInput) {
                displayError('Erreur : Éléments de l’interface manquants.');
                return;
            }

            if (!query || query.length < 3) {
                suggestions.innerHTML = '';
                suggestions.style.display = 'none';
                usernameInput.removeAttribute('aria-busy');
                return;
            }

            usernameInput.setAttribute('aria-busy', 'true');
            suggestions.innerHTML = '<div class="suggestion-item">Recherche...</div>';
            suggestions.style.display = 'block';

            try {
                const profileData = await fetchWithCache(`profile_${query.toLowerCase()}`, async () => {
                    const response = await fetch(graphqlEndpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            query: profileQuery,
                            variables: { id: query.toLowerCase() }
                        })
                    });

                    if (!response.ok) throw new Error(`Erreur HTTP : ${response.status}`);
                    const result = await response.json();
                    if (result.errors) throw new Error(result.errors.map(e => e.message).join(', '));
                    return result.data?.public?.user;
                });

                suggestions.innerHTML = '';
                if (profileData?.username) {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.tabIndex = 0;
                    item.innerHTML = `
                        ${profileData.avatar?.url ? `<img src="${sanitizeInput(profileData.avatar.url)}" alt="Avatar de ${sanitizeInput(profileData.username)}" loading="lazy">` : ''}
                        <span>${sanitizeInput(profileData.username)}</span>
                    `;
                    item.addEventListener('click', () => selectSuggestion(profileData.username));
                    item.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') selectSuggestion(profileData.username);
                    });
                    suggestions.appendChild(item);
                    suggestions.style.display = 'block';
                } else {
                    suggestions.innerHTML = '<div class="suggestion-item">Aucun profil trouvé</div>';
                    suggestions.style.display = 'block';
                }
            } catch (error) {
                displayError(`Erreur lors de la recherche : ${error.message}`);
                suggestions.innerHTML = '<div class="suggestion-item">Aucun profil trouvé</div>';
                suggestions.style.display = 'block';
            } finally {
                usernameInput.removeAttribute('aria-busy');
            }
        }

        function clearSuggestions() {
            const suggestions = document.getElementById('suggestions');
            if (suggestions) {
                suggestions.innerHTML = '';
                suggestions.style.display = 'none';
            }
        }

        function selectSuggestion(username) {
            const usernameInput = document.getElementById('usernameInput');
            if (usernameInput) {
                usernameInput.value = username;
                clearSuggestions();
                fetchProfileAndNFTs();
            }
        }

        async function fetchAllNFTs(ownerId, progressCallback) {
            const first = 60;
            let skip = 0;
            let allAssets = [];
            let hasMore = true;

            while (hasMore && !isProfileLoadingCancelled) {
                const response = await fetch(graphqlEndpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: nftQuery, variables: { ownerId, first, skip } })
                });

                if (!response.ok) throw new Error(`Erreur HTTP : ${response.status}`);
                const result = await response.json();
                if (result.errors) throw new Error(result.errors.map(e => e.message).join(', '));

                const assets = result.data?.public?.profileAssets || [];
                allAssets = [...allAssets, ...assets];
                skip += first;
                hasMore = assets.length === first;
                if (progressCallback) progressCallback(allAssets.length);
            }

            return isProfileLoadingCancelled ? [] : allAssets;
        }

        function normalizeText(text) {
            if (!text) return '';
            let normalized = text.normalize('NFKD').replace(/[\u0300-\u036f]/g, '');
            normalized = normalized.replace(/\n\s*\n/g, '\n').trim();
            return normalized;
        }

        function updateProfileUI(profileData) {
            const profileHeader = document.getElementById('profileHeader');
            const profilePicture = document.getElementById('profilePicture');
            const username = document.getElementById('username');
            const verifiedBadge = document.getElementById('verifiedBadge');
            const displayName = document.getElementById('displayName');
            const socialContainer = document.getElementById('socialContainer');
            const croLink = document.getElementById('croLink');
            const croUrl = document.getElementById('croUrl');
            const twitterLink = document.getElementById('twitterLink');
            const twitterUrl = document.getElementById('twitterUrl');
            const facebookLink = document.getElementById('facebookLink');
            const facebookUrl = document.getElementById('facebookUrl');
            const instagramLink = document.getElementById('instagramLink');
            const instagramUrl = document.getElementById('instagramUrl');
            const usernameInput = document.getElementById('usernameInput');

            if (!profileHeader || !profilePicture || !username || !verifiedBadge || !displayName || !socialContainer ||
                !croLink || !croUrl || !twitterLink || !twitterUrl || !facebookLink || !facebookUrl || !instagramLink || !instagramUrl || !usernameInput) {
                displayError('Erreur : Éléments de l’interface manquants.');
                return;
            }

            if (!profileData || !profileData.username) {
                displayError('Données de profil invalides.');
                return;
            }

            username.textContent = profileData.username || 'Inconnu';
            currentUsername = profileData.username?.toLowerCase() || '';
            displayName.textContent = profileData.displayName || '';
            displayName.style.display = profileData.displayName ? 'block' : 'none';
            currentDisplayName = profileData.displayName || profileData.username || 'Inconnu';

            verifiedBadge.style.display = profileData.verified === true ? 'inline-block' : 'none';
            profilePicture.src = profileData.avatar?.url || '';
            profilePicture.style.display = profileData.avatar?.url ? 'block' : 'none';

            let hasSocialLinks = false;

            if (currentUsername) {
                const croProfileUrl = `https://crypto.com/nft/profile/${sanitizeInput(currentUsername)}`;
                if (isValidUrl(croProfileUrl)) {
                    croUrl.href = croProfileUrl;
                    croLink.style.display = 'inline-block';
                    hasSocialLinks = true;
                }
            }

            if (profileData.twitterUsername) {
                const twitterProfileUrl = `https://x.com/${sanitizeInput(profileData.twitterUsername)}`;
                if (isValidUrl(twitterProfileUrl)) {
                    twitterUrl.href = twitterProfileUrl;
                    twitterLink.style.display = 'inline-block';
                    hasSocialLinks = true;
                }
            } else {
                twitterLink.style.display = 'none';
            }

            if (profileData.facebookUsername) {
                const facebookProfileUrl = `https://facebook.com/${sanitizeInput(profileData.facebookUsername)}`;
                if (isValidUrl(facebookProfileUrl)) {
                    facebookUrl.href = facebookProfileUrl;
                    facebookLink.style.display = 'inline-block';
                    hasSocialLinks = true;
                }
            } else {
                facebookLink.style.display = 'none';
            }

            if (profileData.instagramUsername) {
                const instagramProfileUrl = `https://instagram.com/${sanitizeInput(profileData.instagramUsername)}`;
                if (isValidUrl(instagramProfileUrl)) {
                    instagramUrl.href = instagramProfileUrl;
                    instagramLink.style.display = 'inline-block';
                    hasSocialLinks = true;
                }
            } else {
                instagramLink.style.display = 'none';
            }

            socialContainer.style.display = hasSocialLinks ? 'flex' : 'none';
            profileHeader.style.display = 'block';
            usernameInput.value = '';
        }

        async function fetchProfileAndNFTs() {
            const usernameInput = document.getElementById('usernameInput');
            const errorDiv = document.getElementById('error');
            const noResultsDiv = document.getElementById('noResults');
            const controls = document.getElementById('controls');
            const collectionTitle = document.getElementById('collectionTitle');
            const profileHeader = document.getElementById('profileHeader');
            const nftContainer = document.getElementById('nftContainer');
            const nftCountContainer = document.getElementById('nftCountContainer');
            const collectionFilter = document.getElementById('collectionFilter');
            const displayMode = document.getElementById('displayMode');
            const cardSize = document.getElementById('cardSize');
            const sortBy = document.getElementById('sortBy');
            const downloadZipButton = document.getElementById('downloadZipButton');
            const progressModal = document.getElementById('progressModal');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const modalTitle = document.getElementById('modalTitle');
            const cancelButton = document.getElementById('cancelDownloadButton');

            if (!usernameInput || !errorDiv || !noResultsDiv || !controls || !collectionTitle ||
                !profileHeader || !nftContainer || !nftCountContainer || !collectionFilter || 
                !displayMode || !cardSize || !sortBy || !downloadZipButton || !progressModal || 
                !progressBar || !progressText || !modalTitle || !cancelButton) {
                displayError('Erreur : Éléments de l’interface manquants.');
                return;
            }

            const username = sanitizeInput(usernameInput.value.trim());
            if (!username || username === currentUsername) return;

            currentUsername = username.toLowerCase();
            lastSearchedUsername = currentUsername;

            clearSuggestions();

            profileHeader.style.display = 'none';
            nftContainer.innerHTML = '';
            nftCountContainer.innerHTML = '';
            noResultsDiv.style.display = 'none';
            controls.classList.remove('visible');
            collectionTitle.textContent = '';
            collectionTitle.classList.remove('visible');
            errorDiv.textContent = '';
            downloadZipButton.style.display = 'none';

            collectionFilter.innerHTML = '<option value="">Toutes les collections</option>';
            collectionFilter.value = '';
            collectionFilter.disabled = true;
            displayMode.value = 'full';
            cardSize.value = 'medium';
            sortBy.value = 'default';

            modalTitle.textContent = 'Chargement du profil';
            progressText.textContent = `Chargement du profil pour ${username}...`;
            progressBar.style.width = '0%';
            progressModal.style.display = 'flex';
            cancelButton.style.display = 'block';

            isProfileLoadingCancelled = false;
            cancelButton.onclick = () => {
                isProfileLoadingCancelled = true;
                progressText.textContent = 'Chargement annulé.';
                progressBar.style.width = '0%';
                setTimeout(() => {
                    progressModal.style.display = 'none';
                    window.location.href = homeUrl;
                }, 1000);
            };

            let progress = 0;
            const progressInterval = setInterval(() => {
                if (isProfileLoadingCancelled) {
                    clearInterval(progressInterval);
                    return;
                }
                progress += 10;
                progressBar.style.width = `${Math.min(progress, 80)}%`;
            }, 500);

            try {
                const profileData = await fetchWithCache(`profile_${currentUsername}`, async () => {
                    const response = await fetch(graphqlEndpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            query: profileQuery,
                            variables: { id: currentUsername }
                        })
                    });

                    if (!response.ok) throw new Error(`Erreur HTTP : ${response.status}`);
                    const result = await response.json();
                    if (result.errors) throw new Error(result.errors.map(e => e.message).join(', '));
                    return result.data?.public?.user;
                });

                if (isProfileLoadingCancelled) {
                    clearInterval(progressInterval);
                    return;
                }

                if (!profileData) {
                    clearInterval(progressInterval);
                    progressModal.style.display = 'none';
                    noResultsDiv.style.display = 'block';
                    return;
                }

                updateProfileUI(profileData);

                const newUrl = `${window.location.pathname}#${currentUsername}`;
                history.pushState({ username: currentUsername }, '', newUrl);

                progressText.textContent = `0 actifs`;
                allNFTs = await fetchWithCache(`nfts_${currentUsername}`, () => fetchAllNFTs(currentUsername, (nftCount) => {
                    if (isProfileLoadingCancelled) return;
                    progressText.textContent = `${nftCount} actifs`;
                }));

                if (isProfileLoadingCancelled) {
                    clearInterval(progressInterval);
                    return;
                }

                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                progressText.textContent = `${allNFTs.length} actifs chargés avec succès !`;
                setTimeout(() => progressModal.style.display = 'none', 500);

                if (allNFTs.length > 0) {
                    populateCollectionFilter(allNFTs);
                    collectionFilter.disabled = false;
                    controls.classList.add('visible');

                    const hash = window.location.hash;
                    const hashParts = hash.split('/#');
                    if (hashParts.length > 1 && hashParts[1]) {
                        const collection = decodeURIComponent(hashParts[1]);
                        collectionFilter.value = collection;
                        filterNFTs();
                    } else {
                        updateDisplay();
                    }
                } else {
                    noResultsDiv.style.display = 'block';
                }
            } catch (error) {
                if (!isProfileLoadingCancelled) {
                    clearInterval(progressInterval);
                    progressModal.style.display = 'none';
                    displayError(`Erreur : ${error.message}`);
                }
            }
        }

        function populateCollectionFilter(nfts) {
            const collectionFilter = document.getElementById('collectionFilter');
            if (!collectionFilter) {
                displayError('Erreur : Filtre de collection manquant.');
                return;
            }

            const collectionCounts = {};
            nfts.forEach(nft => {
                const collectionName = nft.collection?.name;
                if (collectionName) {
                    collectionCounts[collectionName] = (collectionCounts[collectionName] || 0) + 1;
                }
            });

            const sortedCollections = Object.keys(collectionCounts).sort((a, b) => collectionCounts[b] - collectionCounts[a]);

            collectionFilter.innerHTML = '<option value="">Toutes les collections</option>';
            sortedCollections.forEach(collection => {
                const option = document.createElement('option');
                option.value = collection;
                option.textContent = `${collection} (${collectionCounts[collection]})`;
                collectionFilter.appendChild(option);
            });
        }

        function filterNFTs() {
            const collectionFilter = document.getElementById('collectionFilter');
            const displayMode = document.getElementById('displayMode');
            const cardSize = document.getElementById('cardSize');
            const sortBy = document.getElementById('sortBy');
            const collectionTitle = document.getElementById('collectionTitle');

            if (!collectionFilter || !displayMode || !cardSize || !sortBy || !collectionTitle) {
                displayError('Erreur : Éléments de filtrage manquants.');
                return;
            }

            if (!allNFTs || !allNFTs.length) {
                displayNFTs([], '');
                collectionTitle.textContent = '';
                collectionTitle.classList.remove('visible');
                return;
            }

            const collectionValue = collectionFilter.value;
            let filteredNFTs = collectionValue
                ? allNFTs.filter(nft => nft.collection?.name === collectionValue)
                : [...allNFTs];

            const sortValue = sortBy.value;
            if (sortValue === 'rank') {
                filteredNFTs.sort((a, b) => (a.defaultRarityRank || Infinity) - (b.defaultRarityRank || Infinity));
            } else if (sortValue === 'newest') {
                filteredNFTs.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            } else if (sortValue === 'oldest') {
                filteredNFTs.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
            } else {
                filteredNFTs.sort((a, b) => a.id.localeCompare(b.id));
            }

            collectionTitle.textContent = collectionValue || 'Toutes les collections';
            collectionTitle.classList.add('visible');

            const newUrl = collectionValue
                ? `${window.location.pathname}#${currentUsername}/#${encodeURIComponent(collectionValue)}`
                : `${window.location.pathname}#${currentUsername}`;
            history.pushState({ username: currentUsername, collection: collectionValue }, '', newUrl);

            displayNFTs(filteredNFTs, collectionValue);
        }

        function displayNFTs(assets, selectedCollection) {
            const container = document.getElementById('nftContainer');
            const countContainer = document.getElementById('nftCountContainer');
            const downloadZipButton = document.getElementById('downloadZipButton');
            const displayMode = document.getElementById('displayMode')?.value;
            const cardSize = document.getElementById('cardSize')?.value;

            if (!container || !countContainer || !downloadZipButton) {
                displayError('Erreur : Éléments de l’interface manquants.');
                return;
            }

            countContainer.innerHTML = '';
            container.className = `nft-container ${displayMode}-mode ${cardSize}-size`;
            container.innerHTML = '';

            const countElement = document.createElement('p');
            countElement.className = 'nft-count';
            countElement.innerHTML = selectedCollection
                ? `<span style="color: var(--color1);">${sanitizeInput(currentUsername.toUpperCase())}</span> possède <span class="count">${assets.length}</span> actifs dans cette collection.`
                : `<span style="color: var(--color1);">${sanitizeInput(currentUsername.toUpperCase())}</span> possède <span class="count">${assets.length}</span> actifs.`;
            countContainer.appendChild(countElement);

            downloadZipButton.style.display = assets.length > 0 ? 'block' : 'none';

            if (displayMode === 'thumbnail') {
                const cardWidth = cardSize === 'small' ? 110 : cardSize === 'large' ? 280 : 180;
                container.style.width = '100%';
                container.style.maxWidth = '100vw';
                container.style.gridTemplateColumns = `repeat(auto-fill, ${cardWidth}px)`;

                assets.forEach((asset, index) => {
                    const imageUrl = asset.cover?.url || 'https://via.placeholder.com/150';
                    const card = document.createElement('div');
                    card.className = 'nft-card';
                    card.tabIndex = 0;

                    let mediaElement;
                    if (imageUrl.endsWith('.mp4')) {
                        mediaElement = document.createElement('video');
                        mediaElement.src = imageUrl;
                        mediaElement.controls = true;
                        mediaElement.muted = true;
                        mediaElement.loop = true;
                        mediaElement.setAttribute('playsinline', '');
                    } else {
                        mediaElement = document.createElement('img');
                        mediaElement.src = imageUrl;
                        mediaElement.alt = asset.name || 'Image NFT';
                        mediaElement.decoding = 'async';
                        mediaElement.sizes = '(max-width: 768px) 80px, 200px';
                    }

                    mediaElement.onerror = () => {
                        card.innerHTML = '';
                        const placeholder = document.createElement('div');
                        placeholder.className = 'media-placeholder';
                        placeholder.textContent = 'Média indisponible';
                        card.appendChild(placeholder);
                    };

                    const tooltip = document.createElement('span');
                    tooltip.className = 'tooltip';
                    tooltip.textContent = asset.name || 'NFT sans nom';
                    card.appendChild(tooltip);

                    card.appendChild(mediaElement);
                    container.appendChild(card);
                });
            } else {
                container.style.gridTemplateColumns = '';
                container.style.width = '';
                container.style.maxWidth = '100vw';

                assets.forEach((asset, index) => {
                    const imageUrl = asset.cover?.url || 'https://via.placeholder.com/150';
                    const card = document.createElement('div');
                    card.className = 'nft-card';
                    card.tabIndex = 0;

                    let mediaElement;
                    if (imageUrl.endsWith('.mp4')) {
                        mediaElement = document.createElement('video');
                        mediaElement.src = imageUrl;
                        mediaElement.controls = true;
                        mediaElement.muted = true;
                        mediaElement.loop = true;
                        mediaElement.setAttribute('playsinline', '');
                    } else {
                        mediaElement = document.createElement('img');
                        mediaElement.src = imageUrl;
                        mediaElement.alt = asset.name || 'Image NFT';
                        mediaElement.decoding = 'async';
                        mediaElement.sizes = '(max-width: 768px) 80px, 200px';
                    }

                    mediaElement.onerror = () => {
                        card.innerHTML = '';
                        const placeholder = document.createElement('div');
                        placeholder.className = 'media-placeholder';
                        placeholder.textContent = 'Média indisponible';
                        card.appendChild(placeholder);
                    };

                    const title = document.createElement('h3');
                    const name = asset.name || 'NFT sans nom';
                    const highlightedName = name.replace(/(#|\d+)/g, '<span class="highlight">$1</span>');
                    title.innerHTML = highlightedName;
                    title.title = name; // Infobulle pour texte tronqué

                    card.appendChild(mediaElement);
                    card.appendChild(title);
                    container.appendChild(card);
                });
            }
        }

        async function downloadNFTsAsZip() {
            const zip = new JSZip();
            const nftContainer = document.getElementById('nftContainer');
            const errorDiv = document.getElementById('error');
            const progressModal = document.getElementById('progressModal');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const modalTitle = document.getElementById('modalTitle');
            const cancelButton = document.getElementById('cancelDownloadButton');

            if (!nftContainer || !errorDiv || !progressModal || !progressBar || !progressText || !modalTitle || !cancelButton) {
                displayError('Erreur : Éléments de l’interface manquants.');
                return;
            }

            const collectionFilter = document.getElementById('collectionFilter');
            const collectionValue = collectionFilter ? collectionFilter.value : '';
            let filteredNFTs = collectionValue
                ? allNFTs.filter(nft => nft.collection?.name === collectionValue)
                : [...allNFTs];

            if (filteredNFTs.length === 0) {
                displayError('Aucun NFT disponible pour le téléchargement.');
                return;
            }

            isDownloadCancelled = false;
            modalTitle.textContent = 'Création du fichier ZIP';
            progressModal.style.display = 'flex';
            progressText.textContent = `Préparation du téléchargement de ${filteredNFTs.length} NFTs...`;
            progressBar.style.width = '0%';
            cancelButton.style.display = 'block';

            cancelButton.onclick = () => {
                isDownloadCancelled = true;
                progressText.textContent = 'Téléchargement annulé.';
                progressBar.style.width = '0%';
                setTimeout(() => {
                    progressModal.style.display = 'none';
                    cancelButton.style.display = 'none';
                }, 1000);
            };

            try {
                const nameCounts = {};
                for (let i = 0; i < filteredNFTs.length; i++) {
                    if (isDownloadCancelled) return;
                    const asset = filteredNFTs[i];
                    const url = asset.cover?.url;
                    if (!url) continue;

                    const isVideo = url.endsWith('.mp4');
                    const extension = isVideo ? '.mp4' : url.endsWith('.gif') ? '.gif' : '.png';
                    let baseFileName = asset.name || `nft_${i + 1}`;
                    baseFileName = sanitizeFileNameForZip(baseFileName);
                    let fileName = nameCounts[baseFileName] ? `${baseFileName}_${nameCounts[baseFileName]}${extension}` : `${baseFileName}${extension}`;
                    nameCounts[baseFileName] = (nameCounts[baseFileName] || 0) + 1;

                    progressText.textContent = `Téléchargement de ${fileName} (${i + 1}/${filteredNFTs.length})...`;
                    progressBar.style.width = `${((i + 1) / filteredNFTs.length) * 100}%`;

                    try {
                        const response = await fetch(url, { mode: 'cors', credentials: 'omit' });
                        if (!response.ok) throw new Error(`Échec du téléchargement : ${url}`);
                        const blob = await response.blob();
                        zip.file(fileName, blob);
                    } catch (err) {
                        console.error(`Erreur lors du téléchargement de ${url} : ${err.message}`);
                    }
                }

                if (!isDownloadCancelled) {
                    progressText.textContent = 'Génération du fichier ZIP...';
                    const zipBlob = await zip.generateAsync({ type: 'blob' });
                    saveAs(zipBlob, `${sanitizeInput(currentUsername)}_nfts.zip`);
                }
            } catch (error) {
                if (!isDownloadCancelled) {
                    displayError('Erreur lors de la création du ZIP. Certains fichiers peuvent ne pas être inclus.');
                }
            } finally {
                if (!isDownloadCancelled) {
                    progressModal.style.display = 'none';
                    cancelButton.style.display = 'none';
                }
            }
        }

        function updateDisplay() {
            filterNFTs();
        }

        // Afficher les erreurs
        function displayError(message) {
            const errorContainer = document.getElementById('errorContainer');
            const errorDiv = document.getElementById('error');
            if (errorContainer && errorDiv) {
                errorDiv.textContent = message;
                errorContainer.style.display = 'block';
            }
        }

        function setupEventListeners() {
            const usernameInput = document.getElementById('usernameInput');
            const themeButton = document.getElementById('themeButton');
            const collectionFilter = document.getElementById('collectionFilter');
            const displayMode = document.getElementById('displayMode');
            const cardSize = document.getElementById('cardSize');
            const sortBy = document.getElementById('sortBy');

            if (!usernameInput || !themeButton || !collectionFilter || !displayMode || !cardSize || !sortBy) {
                displayError('Erreur : Éléments de l’interface manquants.');
                return;
            }

            usernameInput.addEventListener('input', () => {
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(() => {
                    const query = sanitizeInput(usernameInput.value.trim());
                    searchProfiles(query);
                }, 500); // Débounce à 500ms
            });

            usernameInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    clearSuggestions();
                    fetchProfileAndNFTs();
                }
            });

            themeButton.addEventListener('click', toggleTheme);

            collectionFilter.addEventListener('change', filterNFTs);
            displayMode.addEventListener('change', updateDisplay);
            cardSize.addEventListener('change', updateDisplay);
            sortBy.addEventListener('change', filterNFTs);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            const themeButton = document.getElementById('themeButton');
            if (themeButton) {
                themeButton.textContent = savedTheme === 'dark' ? 'Sombre' : 'Clair';
            }

            const hash = window.location.hash;
            if (hash && hash.startsWith('#')) {
                const hashParts = hash.split('/#');
                const username = sanitizeInput(hashParts[0].substring(1));
                if (username) {
                    document.getElementById('usernameInput').value = username;
                    fetchProfileAndNFTs();
                }
            }

            setupEventListeners();
        });
    </script>
</body>
</html>
