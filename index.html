// Ajouter une variable pour suivre l'utilisateur connecté
let loggedInUser = null;

// Fonction pour mettre à jour le lien Login/Logout
function updateLoginLink() {
    const loginLink = document.getElementById('loginLink');
    if (!loginLink) return;

    if (loggedInUser) {
        loginLink.textContent = 'Logout';
        loginLink.onclick = logout;
    } else {
        loginLink.textContent = 'Login';
        loginLink.onclick = showLoginModal;
    }
}

// Afficher la modale de connexion
function showLoginModal(event) {
    event.preventDefault();
    const loginModal = document.getElementById('loginModal');
    const loginUsernameInput = document.getElementById('loginUsernameInput');
    if (loginModal && loginUsernameInput) {
        loginModal.style.display = 'flex';
        loginUsernameInput.value = '';
        loginUsernameInput.focus();
        clearLoginSuggestions();
        const navbarMenu = document.getElementById('navbarMenu');
        if (navbarMenu) {
            navbarMenu.classList.remove('active');
            const toggle = document.querySelector('.navbar-toggle');
            if (toggle) toggle.setAttribute('aria-expanded', 'false');
        }
    }
}

// Effacer les suggestions de la modale de connexion
function clearLoginSuggestions() {
    const suggestions = document.getElementById('loginSuggestions');
    if (suggestions) {
        suggestions.innerHTML = '';
        suggestions.style.display = 'none';
    }
}

// Recherche de profils pour la connexion
async function searchLoginProfiles(query) {
    const suggestions = document.getElementById('loginSuggestions');
    if (!suggestions) {
        console.error('Login suggestions container not found');
        return;
    }

    if (!query || query.length < 3) {
        suggestions.innerHTML = '';
        suggestions.style.display = 'none';
        return;
    }

    suggestions.innerHTML = '<div class="suggestion-item">Searching...</div>';
    suggestions.style.display = 'block';

    try {
        const profileData = await fetchWithCache(`profile_${query.toLowerCase()}`, async () => {
            const response = await fetch(graphqlEndpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    query: profileQuery,
                    variables: { id: query.toLowerCase(), cacheId: `getUserQuery-Profile-${query.toLowerCase()}` }
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP Error: ${response.status} - ${response.statusText}`);
            }

            const result = await response.json();
            if (result.errors) {
                throw new Error(`GraphQL Error: ${result.errors.map(e => e.message).join(', ')}`);
            }

            return result.data?.public?.user;
        });

        suggestions.innerHTML = '';
        if (profileData && profileData.username) {
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            
            if (profileData.avatar?.url) {
                const img = document.createElement('img');
                img.src = profileData.avatar.url;
                img.alt = `${profileData.username} avatar`;
                img.onerror = () => {
                    console.error(`Failed to load avatar for ${profileData.username}`);
                    img.style.display = 'none';
                };
                item.appendChild(img);
            }

            const text = document.createElement('span');
            text.textContent = profileData.username;
            item.appendChild(text);

            item.dataset.username = profileData.username;
            item.addEventListener('click', () => {
                selectLoginSuggestion(profileData.username);
            });
            suggestions.appendChild(item);
            suggestions.style.display = 'block';
        } else {
            suggestions.innerHTML = '<div class="suggestion-item">No profile found</div>';
            suggestions.style.display = 'block';
        }
    } catch (error) {
        console.error(`Error in searchLoginProfiles: ${error.message}`);
        suggestions.innerHTML = '<div class="suggestion-item">No profile found</div>';
        suggestions.style.display = 'block';
    }
}

// Sélectionner une suggestion dans la modale de connexion
function selectLoginSuggestion(username) {
    const loginUsernameInput = document.getElementById('loginUsernameInput');
    if (loginUsernameInput) {
        loginUsernameInput.value = username;
        clearLoginSuggestions();
    }
}

// Gérer la connexion
async function handleLogin() {
    const loginUsernameInput = document.getElementById('loginUsernameInput');
    const loginModal = document.getElementById('loginModal');
    const errorDiv = document.getElementById('error');
    if (!loginUsernameInput || !loginModal || !errorDiv) return;

    const username = sanitizeInput(loginUsernameInput.value.trim());
    if (!username) {
        errorDiv.textContent = 'Please enter a username.';
        return;
    }

    try {
        const profileData = await fetchWithCache(`profile_${username.toLowerCase()}`, async () => {
            const response = await fetch(graphqlEndpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    query: profileQuery,
                    variables: { id: username.toLowerCase(), cacheId: `getUserQuery-Profile-${username.toLowerCase()}` }
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP Error: ${response.status} - ${response.statusText}`);
            }

            const result = await response.json();
            if (result.errors) {
                throw new Error(`GraphQL Error: ${result.errors.map(e => e.message).join(', ')}`);
            }

            return result.data?.public?.user;
        });

        if (profileData && profileData.username) {
            loggedInUser = {
                username: profileData.username,
                displayName: profileData.displayName || profileData.username,
                avatar: profileData.avatar?.url || ''
            };
            localStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));
            updateLoginLink();
            loginModal.style.display = 'none';
            errorDiv.textContent = '';
            // Charger automatiquement le profil de l'utilisateur connecté
            const usernameInput = document.getElementById('usernameInput');
            if (usernameInput) {
                usernameInput.value = loggedInUser.username;
                fetchProfileAndNFTs();
            }
        } else {
            errorDiv.textContent = 'Profile not found.';
        }
    } catch (error) {
        console.error(`Login error: ${error.message}`);
        errorDiv.textContent = `Error: ${error.message}`;
    }
}

// Gérer la déconnexion
function logout(event) {
    event.preventDefault();
    loggedInUser = null;
    localStorage.removeItem('loggedInUser');
    updateLoginLink();
    // Réinitialiser l'interface
    const profileHeader = document.getElementById('profileHeader');
    const nftContainer = document.getElementById('nftContainer');
    const nftCountContainer = document.getElementById('nftCountContainer');
    const noResultsDiv = document.getElementById('noResults');
    const controls = document.getElementById('controls');
    const collectionTitle = document.getElementById('collectionTitle');
    const collectionFilter = document.getElementById('collectionFilter');
    const usernameInput = document.getElementById('usernameInput');
    const downloadZipButton = document.getElementById('downloadZipButton');

    if (profileHeader) profileHeader.style.display = 'none';
    if (nftContainer) nftContainer.innerHTML = '';
    if (nftCountContainer) nftCountContainer.innerHTML = '';
    if (noResultsDiv) noResultsDiv.style.display = 'none';
    if (controls) controls.classList.remove('visible');
    if (collectionTitle) {
        collectionTitle.textContent = '';
        collectionTitle.classList.remove('visible');
    }
    if (collectionFilter) {
        collectionFilter.innerHTML = '<option value="">All Collections</option>';
        collectionFilter.disabled = true;
    }
    if (usernameInput) usernameInput.value = '';
    if (downloadZipButton) downloadZipButton.style.display = 'none';

    allNFTs = [];
    currentUsername = '';
    history.pushState({}, '', window.location.pathname);
    window.location.href = homeUrl;
}

// Mettre à jour setupEventListeners pour inclure la modale de connexion
function setupEventListeners() {
    const usernameInput = document.getElementById('usernameInput');
    const loginUsernameInput = document.getElementById('loginUsernameInput');
    const themeButton = document.getElementById('themeButton');
    const collectionFilter = document.getElementById('collectionFilter');
    const displayMode = document.getElementById('displayMode');
    const cardSize = document.getElementById('cardSize');
    const sortBy = document.getElementById('sortBy');
    const navbarMenu = document.getElementById('navbarMenu');
    const confirmLoginButton = document.getElementById('confirmLoginButton');
    const cancelLoginButton = document.getElementById('cancelLoginButton');

    if (!usernameInput || !loginUsernameInput || !themeButton || !collectionFilter || 
        !displayMode || !cardSize || !sortBy || !navbarMenu || !confirmLoginButton || !cancelLoginButton) {
        console.error('One or more DOM elements not found');
        const errorDiv = document.getElementById('error');
        if (errorDiv) errorDiv.textContent = 'Internal error: UI elements missing.';
        return;
    }

    const isMobile = window.innerWidth <= 768;
    const debounceDelay = isMobile ? 500 : 300;

    // Événements pour la recherche de profils
    usernameInput.addEventListener('input', () => {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(() => {
            const query = sanitizeInput(usernameInput.value.trim());
            searchProfiles(query);
        }, debounceDelay);
    });

    usernameInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
            clearSuggestions();
            fetchProfileAndNFTs();
        }
    });

    usernameInput.addEventListener('blur', () => {
        resetViewportZoom();
    });

    // Événements pour la recherche dans la modale de connexion
    loginUsernameInput.addEventListener('input', () => {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(() => {
            const query = sanitizeInput(loginUsernameInput.value.trim());
            searchLoginProfiles(query);
        }, debounceDelay);
    });

    loginUsernameInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
            clearLoginSuggestions();
            handleLogin();
        }
    });

    confirmLoginButton.addEventListener('click', handleLogin);
    cancelLoginButton.addEventListener('click', () => {
        const loginModal = document.getElementById('loginModal');
        if (loginModal) loginModal.style.display = 'none';
        clearLoginSuggestions();
    });

    themeButton.addEventListener('click', toggleTheme);

    collectionFilter.addEventListener('change', filterNFTs);
    displayMode.addEventListener('change', updateDisplay);
    cardSize.addEventListener('change', updateDisplay);
    sortBy.addEventListener('change', filterNFTs);

    navbarMenu.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', () => {
            navbarMenu.classList.remove('active');
            const toggle = document.querySelector('.navbar-toggle');
            if (toggle) toggle.setAttribute('aria-expanded', 'false');
        });
    });

    document.addEventListener('touchstart', (event) => {
        if (event.touches.length > 1) {
            event.preventDefault();
        }
    }, { passive: false });
}

// Vérifier l'utilisateur connecté au chargement
document.addEventListener('DOMContentLoaded', () => {
    const savedTheme = localStorage.getItem('theme') || 'dark';
    document.documentElement.setAttribute('data-theme', savedTheme);
    const themeButton = document.getElementById('themeButton');
    if (themeButton) {
        themeButton.textContent = savedTheme.charAt(0).toUpperCase() + savedTheme.slice(1);
    }

    // Vérifier si un utilisateur est connecté
    const savedUser = localStorage.getItem('loggedInUser');
    if (savedUser) {
        loggedInUser = JSON.parse(savedUser);
        updateLoginLink();
        const usernameInput = document.getElementById('usernameInput');
        if (usernameInput && loggedInUser.username) {
            usernameInput.value = loggedInUser.username;
            fetchProfileAndNFTs();
        }
    } else {
        updateLoginLink();
    }

    const hash = window.location.hash;
    if (hash && hash.startsWith('#') && !loggedInUser) {
        const hashParts = hash.split('/#');
        const username = sanitizeInput(hashParts[0].substring(1));
        const usernameInput = document.getElementById('usernameInput');
        if (usernameInput && username) {
            usernameInput.value = username;
            fetchProfileAndNFTs();
        }
    }

    setupEventListeners();
});
